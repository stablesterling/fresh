<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoFo Music</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0d0d0d; --gold: #c5a367; --soft: #e5e5e5; --muted: #666666; --serif: 'Cormorant Garamond', serif; --sans: 'Montserrat', sans-serif; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--soft); font-family: var(--sans); overflow-x: hidden; }
        .hidden { display: none !important; }
        .auth-container { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .auth-card { background: #111; padding: 30px; border-radius: 8px; width: 90%; max-width: 350px; text-align: center; border: 1px solid #222; }
        .auth-card input { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 4px; outline: none; }
        nav { display: flex; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid #111; background: var(--bg); position: sticky; top: 0; z-index: 100; }
        .track { padding: 10px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #111; cursor: pointer; transition: 0.2s; }
        .track:active { background: #1a1a1a; }
        .track img { width: 50px; height: 50px; border-radius: 4px; object-fit: cover; }
        .player { position: fixed; bottom: 0; width: 100%; background: #050505; border-top: 1px solid var(--gold); padding: 15px 20px; display: flex; align-items: center; gap: 10px; z-index: 1000; }
        #progress-bar { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: #222; cursor: pointer; }
        #progress-inner { height: 100%; background: var(--gold); width: 0%; transition: width 0.1s linear; }
        .play-btn { background: var(--gold); border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="authScreen" class="auth-container">
    <div id="loginForm" class="auth-card">
        <h2 style="font-family: var(--serif); color: var(--gold); margin-bottom: 20px; letter-spacing: 5px;">VOFO</h2>
        <input type="text" id="lUser" placeholder="USERNAME">
        <input type="password" id="lPass" placeholder="PASSWORD">
        <button onclick="handleAuth('login')" style="width:100%; padding:12px; background:var(--gold); border:none; cursor:pointer; font-weight:600;">LOGIN</button>
        <p onclick="toggleAuth('reg')" style="font-size:10px; color:var(--muted); margin-top:15px; cursor:pointer;">SIGN UP</p>
    </div>
    <div id="regForm" class="auth-card hidden">
        <h2 style="font-family: var(--serif); color: var(--gold); margin-bottom: 20px;">REGISTER</h2>
        <input type="text" id="rUser" placeholder="USERNAME">
        <input type="password" id="rPass" placeholder="PASSWORD">
        <button onclick="handleAuth('register')" style="width:100%; padding:12px; background:var(--gold); border:none; cursor:pointer; font-weight:600;">CREATE ACCOUNT</button>
        <p onclick="toggleAuth('log')" style="font-size:10px; color:var(--muted); margin-top:15px; cursor:pointer;">BACK TO LOGIN</p>
    </div>
</div>

<div id="app" class="hidden">
    <nav>
        <div style="font-family: var(--serif); color:var(--gold); letter-spacing: 2px;">VOFO</div>
        <div style="font-size: 10px; letter-spacing: 1px;">
            <span onclick="switchTab('exp')" id="btnExp" style="color:var(--gold); margin-right:15px; cursor:pointer;">EXPLORE</span>
            <span onclick="switchTab('lib')" id="btnLib" style="color:var(--muted); cursor:pointer;">LIBRARY</span>
        </div>
    </nav>
    <div id="exploreTab" style="padding: 20px; max-width: 800px; margin: auto; padding-bottom: 120px;">
        <input id="searchInput" placeholder="Search mood or track..." style="width:100%; padding:14px; background:#111; border:1px solid #222; color:white; border-radius: 4px; margin-bottom:20px;" onkeypress="if(event.key==='Enter') doSearch()">
        <div id="results"></div>
    </div>
    <div id="libraryTab" class="hidden" style="padding: 20px; max-width: 800px; margin: auto; padding-bottom: 120px;">
        <div id="libraryResults"></div>
    </div>
</div>

<div id="playerBar" class="player hidden">
    <div id="progress-bar" onclick="seek(event)"><div id="progress-inner"></div></div>
    <audio id="audio"></audio>
    <img id="pThumb" src="" style="width:45px; height:45px; border-radius:4px; object-fit: cover;">
    <div style="flex:1; min-width:0;">
        <div id="pTitle" style="font-size:13px; color:var(--gold); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-weight: 600;"></div>
        <div id="pArtist" style="font-size:10px; color:var(--muted); text-transform: uppercase;"></div>
    </div>
    <div id="likeBtn" onclick="toggleLike()" style="cursor:pointer; margin-right:10px; font-size: 18px;">❤</div>
    <button onclick="togglePlay()" class="play-btn" id="playBtn">||</button>
</div>

<script>
    let user = JSON.parse(localStorage.getItem('vofo_user'));
    let playlist = [], index = -1, liked = new Set();
    const audio = document.getElementById('audio');

    function toggleAuth(m) {
        document.getElementById('loginForm').classList.toggle('hidden', m==='reg');
        document.getElementById('regForm').classList.toggle('hidden', m==='log');
    }

    async function handleAuth(t) {
        const u = document.getElementById(t==='login'?'lUser':'rUser').value;
        const p = document.getElementById(t==='login'?'lPass':'rPass').value;
        if(!u || !p) return;
        const res = await fetch(`/api/auth/${t}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username:u, password:p})
        });
        const d = await res.json();
        if(d.success) {
            if(t==='login'){ localStorage.setItem('vofo_user', JSON.stringify(d)); location.reload(); }
            else { alert("Registry Created."); toggleAuth('log'); }
        } else alert("Error");
    }

    if(user) {
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        fetchTrending();
        fetchLibrary();
    }

    function switchTab(t) {
        document.getElementById('exploreTab').classList.toggle('hidden', t==='lib');
        document.getElementById('libraryTab').classList.toggle('hidden', t==='exp');
        document.getElementById('btnExp').style.color = t==='exp'?'var(--gold)':'var(--muted)';
        document.getElementById('btnLib').style.color = t==='lib'?'var(--gold)':'var(--muted)';
        if(t==='lib') fetchLibrary();
    }

    async function fetchTrending() {
        const res = await fetch('/api/trending');
        const d = await res.json();
        render(d, 'results');
    }

    async function doSearch() {
        const q = document.getElementById('searchInput').value;
        if(!q) return;
        const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        const d = await res.json();
        render(d, 'results');
    }

    function render(data, id) {
        document.getElementById(id).innerHTML = data.map((s, i) => `
            <div class="track" onclick='playSong(${i}, ${JSON.stringify(data).replace(/'/g, "&apos;")})'>
                <img src="${s.thumbnail}">
                <div><div style="font-size:14px; font-family: var(--serif);">${s.title}</div><div style="font-size:10px; color:var(--muted);">${s.artist}</div></div>
            </div>
        `).join('');
    }

    async function playSong(i, list) {
        playlist = list; index = i;
        const s = playlist[i];
        document.getElementById('playerBar').classList.remove('hidden');
        document.getElementById('pTitle').innerText = "Connecting...";
        document.getElementById('pArtist').innerText = s.artist;
        document.getElementById('pThumb').src = s.thumbnail;
        const res = await fetch(`/api/stream?id=${s.id}`);
        const d = await res.json();
        audio.src = d.url; audio.play();
        document.getElementById('pTitle').innerText = s.title;
        updateLikeUI(s.id);
    }

    function togglePlay() { 
        audio.paused ? audio.play() : audio.pause(); 
        document.getElementById('playBtn').innerText = audio.paused ? '▶' : '||'; 
    }

    function seek(e) { audio.currentTime = (e.offsetX / e.target.offsetWidth) * audio.duration; }

    audio.ontimeupdate = () => { if(audio.duration) document.getElementById('progress-inner').style.width = (audio.currentTime/audio.duration)*100+"%"; };

    // AUTO-NEXT FEATURE
    audio.onended = () => {
        if(index < playlist.length - 1) {
            playSong(index + 1, playlist);
        }
    };

    async function fetchLibrary() {
        const res = await fetch(`/api/library/${user.user_id}`);
        const d = await res.json();
        liked = new Set(d.map(s => s.id));
        if(!document.getElementById('libraryTab').classList.contains('hidden')) render(d, 'libraryResults');
    }

    async function toggleLike() {
        const s = playlist[index];
        const res = await fetch('/api/like', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({...s, user_id: user.user_id})
        });
        const d = await res.json();
        d.status === 'liked' ? liked.add(s.id) : liked.delete(s.id);
        updateLikeUI(s.id);
    }

    function updateLikeUI(id) { document.getElementById('likeBtn').style.color = liked.has(id)?'#ff4b2b':'var(--muted)'; }
</script>
</body>
</html>
